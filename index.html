<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psicometría Aplicada II - Sistema de Repaso</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ---------- MODO OSCURO / CLARO ---------- */
        :root[data-theme="light"] {
            --bg-color: #f8f9fa;
            --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --text-color: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        :root[data-theme="dark"] {
            --bg-color: #0f172a;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            --text-color: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* ---------- VARIABLES BASE ---------- */
        :root {
            --primary-color: #6366f1;
            --secondary-color: #a855f7;
            --accent-color: #ec4899;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-out;
        }

        /* ---------- RESET ---------- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        .hidden { display: none !important; }

        /* ---------- CONTENEDOR PRINCIPAL ---------- */
        .container {
            width: 100%;
            max-width: 900px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--glass-shadow);
            padding: 40px;
            text-align: center;
            animation: slideIn 0.6s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ---------- HEADER CON TOGGLE ---------- */
        .header-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .theme-toggle {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            color: var(--text-color);
            transition: var(--transition);
        }
        .theme-toggle:hover { transform: scale(1.1); }

        /* ---------- TÍTULOS ---------- */
        h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 3s ease-in-out infinite;
        }
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
            50% { text-shadow: 0 0 30px rgba(99, 102, 241, 0.6); }
        }
        .subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            margin-bottom: 50px;
            font-weight: 400;
        }

        /* ---------- SELECTORES ---------- */
        .selector-group {
            margin-bottom: 40px;
            text-align: left;
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0;
        }
        .selector-group:nth-child(2) { animation-delay: 0.2s; }
        .selector-group:nth-child(3) { animation-delay: 0.4s; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .selector-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .selector-group label i { color: var(--primary-color); font-size: 1.4rem; }

        select, .mode-selector button {
            width: 100%;
            padding: 18px 20px;
            border-radius: var(--border-radius-sm);
            font-size: 1.1rem;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass-bg);
            color: var(--text-color);
            border: 2px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        select:hover, .mode-selector button:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }
        select:focus { outline: none; border-color: var(--primary-color); }

        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .mode-selector button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        .mode-selector button.selected {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }
        .mode-selector button i { font-size: 2rem; color: var(--primary-color); transition: var(--transition); }
        .mode-selector button.selected i { color: white; }

        /* ---------- BOTONES ---------- */
        #start-btn, #next-btn, #review-errors-btn, #restart-btn, #download-pdf-btn {
            padding: 18px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }
        #start-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            width: 100%;
            max-width: 400px;
            margin-top: 40px;
        }
        #start-btn:hover { transform: scale(1.02) translateY(-3px); }
        #next-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            margin: 25px auto 0;
            display: none;
        }
        #next-btn:hover { transform: scale(1.05) translateY(-2px); }

        /* ---------- QUIZ ---------- */
        #quiz-screen {
            animation: fadeInUp 0.8s ease-out;
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        #progress-text {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #progress-text i { color: var(--primary-color); }
        #timer-container {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--warning-color);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(245, 158, 11, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid rgba(245, 158, 11, 0.3);
        }
        #timer-container i { animation: pulse 1s ease-in-out infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            margin-bottom: 30px;
            overflow: hidden;
            position: relative;
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        #progress-bar::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .question-text {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 30px;
            line-height: 1.5;
            color: var(--text-color);
            text-align: left;
            padding: 20px;
            background: var(--glass-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--glass-border);
        }
        .question-text i { color: var(--primary-color); margin-right: 10px; }

        /* ---------- OPCIONES ---------- */
        .answer-btn {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            color: var(--text-color);
            padding: 18px 24px;
            text-align: left;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.1rem;
            font-family: inherit;
            position: relative;
            overflow: hidden;
            width: 100%;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .answer-btn:hover:not([disabled]) {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(8px);
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.2);
        }
        .answer-btn.correct {
            background: var(--success-color);
            border-color: var(--success-color);
            color: #fff;
            animation: correctPulse 0.6s ease;
        }
        .answer-btn.wrong {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: #fff;
            animation: wrongShake 0.6s ease;
        }
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.7; }

        /* ---------- RESULTADOS ---------- */
        #results-screen {
            animation: fadeInUp 0.8s ease-out;
        }
        #results-screen h2 {
            font-size: 2.5rem;
            margin-bottom: 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        #score-text {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        #score-text .icon { color: var(--success-color); animation: pulse 2s ease-in-out infinite; }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-sm);
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); }
        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-color);
            display: block;
            margin-bottom: 8px;
        }
        .stat-card .stat-label {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        #recommendations {
            margin: 40px 0;
            text-align: left;
            background: var(--glass-bg);
            border-radius: var(--border-radius-sm);
            padding: 30px;
            border: 1px solid var(--glass-border);
        }
        #recommendations h3 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.5rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        #recommendations h3 i { color: var(--warning-color); }
        #recommendations ul { list-style: none; padding: 0; }
        #recommendations li {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            border-left: 4px solid var(--warning-color);
            transition: var(--transition);
        }
        #recommendations li:hover { transform: translateX(5px); background: rgba(0, 0, 0, 0.3); }
        #recommendations .source {
            font-style: italic;
            opacity: 0.8;
            font-size: 0.9em;
            margin-top: 8px;
            display: block;
            color: var(--primary-color);
        }
        .results-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        #review-errors-btn {
            background: var(--info-color);
            color: white;
            border: 2px solid var(--info-color);
        }
        #review-errors-btn:hover {
            background: transparent;
            color: var(--info-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        #restart-btn {
            color: var(--text-color);
            background: transparent;
            border: 2px solid var(--glass-border);
        }
        #restart-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }
        #download-pdf-btn {
            background: linear-gradient(135deg, var(--danger-color), #f87171);
            color: white;
            border: 2px solid var(--danger-color);
        }
        #download-pdf-btn:hover {
            background: transparent;
            color: var(--danger-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        /* ---------- MODAL REVISIÓN ---------- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            box-shadow: var(--glass-shadow);
            animation: modalSlideIn 0.4s ease;
            margin: 20px;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .modal-header h3 {
            font-size: 1.8rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-header h3 i { color: var(--danger-color); }
        .close-modal {
            background: var(--danger-color);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        .error-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-sm);
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid var(--danger-color);
            transition: var(--transition);
        }
        .error-card:hover { transform: translateX(5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); }
        .error-question {
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 1.1rem;
        }
        .error-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .user-answer, .correct-answer {
            padding: 15px;
            border-radius: var(--border-radius-sm);
            font-weight: 500;
        }
        .user-answer {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger-color);
            color: var(--text-color);
        }
        .correct-answer {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success-color);
            color: var(--text-color);
        }
        .error-explanation {
            margin-top: 20px;
            padding: 20px;
            background: var(--glass-bg);
            border-radius: var(--border-radius-sm);
            line-height: 1.6;
            border: 1px solid var(--glass-border);
        }

        /* ---------- NOTIFICACIÓN RÉCORD ---------- */
        .new-record-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: var(--bg-color);
            padding: 30px 40px;
            border-radius: var(--border-radius);
            font-size: 1.5rem;
            font-weight: 800;
            text-align: center;
            z-index: 1000;
            animation: recordPop 0.6s ease;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        @keyframes recordPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); }
            80% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        /* ---------- RESPONSIVE ---------- */
        @media (max-width: 768px) {
            .container { padding: 25px; margin: 10px; }
            h1 { font-size: 2.2rem; }
            .mode-selector { grid-template-columns: 1fr; }
            .results-buttons { flex-direction: column; align-items: center; }
            .error-comparison { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .container { padding: 20px; }
            h1 { font-size: 1.8rem; }
            .question-text { font-size: 1.2rem; padding: 15px; }
            .answer-btn { padding: 15px; font-size: 1rem; }
            .modal-content { padding: 25px; margin: 10px; }
        }
    </style>
    <base target="_blank">
</head>
<body>
    <div class="container" id="main-container">
        <!-- ---------- HEADER CON TOGGLE ---------- -->
        <div class="header-bar">
            <button id="theme-toggle" class="theme-toggle" aria-label="Cambiar tema">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- ---------- PANTALLA INICIO ---------- -->
        <div id="start-screen">
            <h1><i class="fas fa-brain"></i> Psicometría Aplicada II</h1>
            <p class="subtitle">Sistema de repaso interactivo y adaptativo</p>
            
            <div class="selector-group">
                <label for="theme-selector"><i class="fas fa-book"></i> Elige un tema para repasar</label>
                <select id="theme-selector" aria-label="Selección de tema">
                    <option value="tct">📊 Teoría Clásica de los Tests (TCT)</option>
                    <option value="confiabilidad">🎯 Confiabilidad</option>
                    <option value="validez">✅ Validez</option>
                    <option value="factorial">🔍 Análisis Factorial</option>
                    <option value="baremacion">📈 Normalización y Baremación</option>
                    <option value="tri">🧮 Teoría de Respuesta a los Ítems (TRI)</option>
                    <option value="random">🎲 Mezcla de todos los temas</option>
                </select>
            </div>

            <div class="selector-group">
                <label><i class="fas fa-gamepad"></i> Elige un modo de juego</label>
                <div class="mode-selector" role="group" aria-label="Modo de juego">
                    <button id="mode-study" class="selected" data-mode="estudio" aria-pressed="true">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Modo Estudio</span>
                        <small>Aprende sin presión</small>
                    </button>
                    <button id="mode-exam" data-mode="examen" aria-pressed="false">
                        <i class="fas fa-stopwatch"></i>
                        <span>Modo Examen</span>
                        <small>Contra reloj</small>
                    </button>
                    <button id="mode-practice" data-mode="practica" aria-pressed="false">
                        <i class="fas fa-infinity"></i>
                        <span>Práctica Ilimitada</span>
                        <small>Sin límite de preguntas</small>
                    </button>
                </div>
            </div>

            <button id="start-btn" aria-label="Comenzar repaso">
                Comenzar Repaso <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- ---------- PANTALLA QUIZ ---------- -->
        <div id="quiz-screen" class="hidden">
            <div class="quiz-header">
                <span id="progress-text"><i class="fas fa-list-ol"></i> Pregunta 1 / 6</span>
                <div id="timer-container">
                    <i class="fas fa-hourglass-half"></i>
                    <span id="timer">30</span>s
                </div>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
            <div id="question-container" aria-live="polite"></div>
            <div id="feedback-container" class="hidden" aria-live="assertive"></div>
            <button id="next-btn" class="hidden">Siguiente <i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- ---------- PANTALLA RESULTADOS ---------- -->
        <div id="results-screen" class="hidden">
            <h2 id="results-title">¡Repaso completado!</h2>
            <p id="score-text"><i class="fas fa-check-circle icon"></i> Tu puntaje: 0 de 6</p>
            
            <div class="stats-container">
                <div class="stat-card">
                    <span class="stat-value" id="accuracy-stat">0%</span>
                    <span class="stat-label">Precisión</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="time-stat">0:00</span>
                    <span class="stat-label">Tiempo Total</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="streak-stat">0</span>
                    <span class="stat-label">Racha Máxima</span>
                </div>
            </div>

            <div id="recommendations" class="hidden">
                <h3><i class="fas fa-lightbulb"></i> Áreas para reforzar</h3>
                <ul id="recommendations-list"></ul>
            </div>

            <div class="results-buttons">
                <button id="review-errors-btn" class="hidden"><i class="fas fa-search"></i> Revisar Errores</button>
                <button id="download-pdf-btn"><i class="fas fa-file-pdf"></i> Descargar resultados en PDF</button>
                <button id="restart-btn"><i class="fas fa-redo"></i> Volver a empezar</button>
            </div>
        </div>
    </div>

    <!-- ---------- MODAL REVISIÓN ---------- -->
    <div id="review-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"><i class="fas fa-exclamation-triangle"></i> Revisar Errores</h3>
                <button class="close-modal" aria-label="Cerrar revisión"><i class="fas fa-times"></i></button>
            </div>
            <div id="review-content"></div>
        </div>
    </div>

    <!-- ---------- SCRIPTS ---------- -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // ---------- SISTEMA DE ESTADO ----------
        class QuizState {
            constructor() {
                this.currentQuestions = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.selectedMode = 'estudio';
                this.timerInterval = null;
                this.startTime = null;
                this.totalTime = 0;
                this.wrongAnswers = [];
                this.records = this.loadRecords();
                this.streak = 0;
                this.maxStreak = 0;
                this.totalAnswered = 0;
            }
            loadRecords() {
                const saved = localStorage.getItem('psicometria-records-v2');
                return saved ? JSON.parse(saved) : {};
            }
            saveRecords() {
                localStorage.setItem('psicometria-records-v2', JSON.stringify(this.records));
            }
            updateRecord(theme, score, totalQuestions, time) {
                const accuracy = Math.round((score / totalQuestions) * 100);
                const prev = this.records[theme];
                const isBetter = !prev || score > prev.bestScore || (score === prev.bestScore && accuracy > prev.bestAccuracy);
                if (isBetter) {
                    this.records[theme] = {
                        bestScore: score,
                        bestAccuracy: accuracy,
                        bestTime: time,
                        attempts: (prev?.attempts || 0) + 1,
                        lastPlayed: Date.now()
                    };
                    this.saveRecords();
                    return true;
                } else {
                    this.records[theme].attempts = (prev?.attempts || 0) + 1;
                    this.records[theme].lastPlayed = Date.now();
                    this.saveRecords();
                    return false;
                }
            }
        }

        // ---------- BANCO DE PREGUNTAS ----------
        const quizData = {
            tct: [
                { type: 'multiple-choice', question: '¿Cuál es la ecuación fundamental del Modelo Lineal Clásico de Spearman?', options: ['X = V + E', 'X = V - E', 'V = X * E', 'E = V / X'], answer: 'X = V + E', explanation: 'La Teoría Clásica de los Tests (TCT) postula que la puntuación empírica (X) de una persona es la suma de su puntuación verdadera (V) y un componente de error (E).', source: 'Teoría Clásica de los Tests.pdf', difficulty: 'medium', icon: '📊' },
                { type: 'flashcard', front: 'Concepto: Puntuación Verdadera (V)', back: 'Es el valor real del atributo que se mide. Teóricamente, se define como la esperanza matemática de la puntuación empírica (X) si se realizaran infinitas mediciones a la misma persona bajo las mismas condiciones.', source: 'Teoría Clásica de los Tests.pdf', difficulty: 'hard', icon: '🎯' },
                { type: 'fill-in-the-blank', question: 'Según los supuestos de la TCT, la correlación entre las puntuaciones verdaderas (V) y los errores de medida (E) es...', options: ['nula (cero)', 'positiva', 'negativa', 'perfecta (uno)'], answer: 'nula (cero)', explanation: 'Un supuesto clave es que el error es aleatorio y no sistemático, por lo tanto, no se correlaciona con el nivel real del atributo medido.', source: 'Las Teorias de los Tests - Muñiz - 2010.pdf', difficulty: 'medium', icon: '🔗' },
                { type: 'multiple-choice', question: 'En la TCT, ¿qué representa el error de medición (E)?', options: ['Factores aleatorios internos y externos que afectan la puntuación', 'Un error de cálculo del evaluador', 'La diferencia entre la puntuación más alta y la más baja', 'La parte de la puntuación que se debe a la inteligencia'], answer: 'Factores aleatorios internos y externos que afectan la puntuación', explanation: 'El error incluye factores como la fatiga, las condiciones ambientales, la motivación del evaluado, etc., que introducen variabilidad aleatoria en la medición.', source: 'Teoría Clásica de los Tests.pdf', difficulty: 'easy', icon: '📊' },
                { type: 'association', question: 'Asocia los conceptos de la TCT con su representación:', items1: ['Puntuación Empírica', 'Puntuación Verdadera', 'Error de Medición', 'Modelo Lineal Clásico'], items2: ['X', 'V', 'E', 'X = V + E'], answer: {'Puntuación Empírica': 'X', 'Puntuación Verdadera': 'V', 'Error de Medición': 'E', 'Modelo Lineal Clásico': 'X = V + E'}, source: 'Teoría Clásica de los Tests.pdf', difficulty: 'medium', icon: '🔗' }
            ],
            confiabilidad: [
                { type: 'multiple-choice', question: '¿Cómo se define el coeficiente de confiabilidad en términos de varianza?', options: ['La proporción de varianza verdadera sobre la varianza empírica', 'La proporción de varianza de error sobre la varianza empírica', 'La suma de la varianza verdadera y la de error', 'La correlación entre el test y un criterio externo'], answer: 'La proporción de varianza verdadera sobre la varianza empírica', explanation: 'El coeficiente de confiabilidad (ρxx\') representa qué parte de la variabilidad total en las puntuaciones observadas se debe a diferencias reales en el atributo medido (varianza verdadera).', source: 'Teoría Clásica de los Tests.pdf', difficulty: 'hard', icon: '🎯' },
                { type: 'flashcard', front: 'Concepto: Error Estándar de Medición (EEM)', back: 'Es la desviación típica de los errores de medición. Indica el margen de error esperado en la puntuación de un individuo y se usa para construir intervalos de confianza alrededor de la puntuación observada.', source: 'Teoría Clásica de los Tests.pdf', difficulty: 'medium', icon: '🎯' },
                { type: 'multiple-choice', question: 'Si un test tiene una confiabilidad de 0.90, ¿qué porcentaje de la varianza de las puntuaciones se debe al error de medición?', options: ['10%', '90%', '0%', '100%'], answer: '10%', explanation: 'La varianza de error es el complemento de la confiabilidad (1 - 0.90 = 0.10). Por lo tanto, el 10% de la varianza total es atribuible al error.', source: 'Teoría Clásica de los Tests.pdf', difficulty: 'medium', icon: '🎯' }
            ],
            validez: [
                { type: 'multiple-choice', question: 'Según la concepción moderna y unitaria de la validez, ¿qué es lo que se valida?', options: ['Las inferencias hechas a partir de las puntuaciones del test', 'El test en sí mismo, como un objeto', 'Únicamente el contenido de los ítems', 'La confiabilidad del instrumento'], answer: 'Las inferencias hechas a partir de las puntuaciones del test', explanation: 'La validez no es una propiedad intrínseca del test, sino el grado en que la evidencia y la teoría apoyan las interpretaciones y usos de las puntuaciones del test.', source: 'Validez.pdf', difficulty: 'hard', icon: '✅' },
                { type: 'association', question: 'Asocia cada fuente de evidencia de validez con su descripción:', items1: ['Evidencia de Contenido', 'Evidencia de Estructura Interna', 'Evidencia de Relación con otras variables', 'Evidencia de Procesos de Respuesta'], items2: ['Análisis de la representatividad y relevancia de los ítems', 'Evaluación de si la estructura del test refleja la del constructo (ej. Análisis Factorial)', 'Correlación del test con criterios externos y otros tests (convergente/discriminante)', 'Análisis de las estrategias cognitivas que usan las personas al responder'], answer: {'Evidencia de Contenido': 'Análisis de la representatividad y relevancia de los ítems', 'Evidencia de Estructura Interna': 'Evaluación de si la estructura del test refleja la del constructo (ej. Análisis Factorial)', 'Evidencia de Relación con otras variables': 'Correlación del test con criterios externos y otros tests (convergente/discriminante)', 'Evidencia de Procesos de Respuesta': 'Análisis de las estrategias cognitivas que usan las personas al responder'}, source: 'Validez.pdf', difficulty: 'hard', icon: '🔗' }
            ],
            factorial: [
                { type: 'multiple-choice', question: '¿Cuál es el objetivo principal del Análisis Factorial Exploratorio (AFE)?', options: ['Descubrir una estructura subyacente en un conjunto de variables', 'Confirmar una estructura teórica predefinida', 'Reducir datos a un único componente', 'Calcular la confiabilidad de un test'], answer: 'Descubrir una estructura subyacente en un conjunto de variables', explanation: 'El AFE es una técnica "basada en los datos" que se utiliza en las primeras etapas de la investigación para generar hipótesis sobre cuántos factores explican las correlaciones entre las variables.', source: 'Guía Comprensiva del Análisis Factorial.pdf', difficulty: 'medium', icon: '🔍' },
                { type: 'flashcard', front: 'Concepto: Rotación Oblicua', back: 'Es un método de rotación de factores (ej. Oblimin, Promax) que permite que los factores extraídos estén correlacionados entre sí. Se considera más realista para la mayoría de los constructos psicológicos.', source: 'Guía Comprensiva del Análisis Factorial.pdf', difficulty: 'hard', icon: '🔍' }
            ],
            baremacion: [
                { type: 'multiple-choice', question: '¿Cuál es el principal objetivo de transformar las puntuaciones directas de un test?', options: ['Facilitar su interpretación ubicando a la persona en relación a un grupo normativo', 'Aumentar la confiabilidad del test', 'Asegurar la validez de contenido', 'Hacer que las puntuaciones sean más altas'], answer: 'Facilitar su interpretación ubicando a la persona en relación a un grupo normativo', explanation: 'Una puntuación bruta (ej. 25 puntos) no significa nada por sí sola. Al transformarla (ej. percentil 80), podemos entender la posición relativa del individuo en comparación con otros.', source: 'Transformación de Puntuaciones.pdf', difficulty: 'easy', icon: '📈' },
                { type: 'flashcard', front: 'Concepto: Puntuación T', back: 'Es una puntuación típica derivada que evita decimales y negativos. Tiene una media preestablecida de 50 y una desviación típica de 10. Es muy común en inventarios de personalidad como el MMPI.', source: 'Transformación de Puntuaciones.pdf', difficulty: 'medium', icon: '📈' }
            ],
            tri: [
                { type: 'multiple-choice', question: 'Una limitación clave de la TCT que la TRI resuelve es que las propiedades de los ítems...', options: ['son invariantes respecto a la muestra utilizada para estimarlas.', 'dependen fuertemente de la muestra utilizada para estimarlas.', 'solo se aplican a tests de inteligencia.', 'son siempre las mismas que las del test completo.'], answer: 'son invariantes respecto a la muestra utilizada para estimarlas.', explanation: 'En TRI, la dificultad (b) o discriminación (a) de un ítem son propiedades del ítem en sí, independientes de la muestra. En TCT, la dificultad depende de la muestra en que se calcula.', source: 'Las Teorías de los Tests - Muñiz - 2010.pdf', difficulty: 'hard', icon: '🧮' },
                { type: 'flashcard', front: 'Concepto: Curva Característica del Ítem (CCI)', back: 'Es una función matemática que relaciona el nivel de una persona en el rasgo latente (θ) con la probabilidad de que acierte el ítem. Es el concepto central de la TRI.', source: 'Las Teorías de los Tests - Muñiz - 2010.pdf', difficulty: 'hard', icon: '🧮' }
            ]
        };

        // ---------- RENDERIZADO DE PREGUNTAS ----------
        class QuestionRenderer {
            constructor(container, state) {
                this.container = container;
                this.state = state;
            }
            render(questionData) {
                this.container.innerHTML = '';
                const icon = questionData.icon || '❓';
                const questionEl = document.createElement('div');
                questionEl.className = 'question-text';
                questionEl.innerHTML = `<span style="font-size: 2rem; margin-right: 15px;">${icon}</span>${questionData.question || questionData.front}`;
                this.container.appendChild(questionEl);
                switch (questionData.type) {
                    case 'multiple-choice':
                    case 'fill-in-the-blank':
                        this.renderMultipleChoice(questionData);
                        break;
                    case 'flashcard':
                        this.renderFlashcard(questionData);
                        break;
                    case 'association':
                        this.renderAssociation(questionData);
                        break;
                }
            }
            renderMultipleChoice(questionData) {
                const optionsContainer = document.createElement('div');
                optionsContainer.id = 'answer-options';
                questionData.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'answer-btn';
                    button.innerHTML = `
                        <span style="font-size: 1.5rem; opacity: 0.7;">${String.fromCharCode(65 + index)}</span>
                        <span>${option}</span>
                    `;
                    button.style.animationDelay = `${index * 0.1}s`;
                    button.addEventListener('click', () => this.handleAnswer(button, option, questionData));
                    optionsContainer.appendChild(button);
                });
                this.container.appendChild(optionsContainer);
            }
            renderFlashcard(questionData) {
                const flashcardContainer = document.createElement('div');
                flashcardContainer.className = 'flashcard-container';
                flashcardContainer.innerHTML = `
                    <div class="flashcard" id="flashcard-${this.state.currentQuestionIndex}">
                        <div class="flashcard-face flashcard-front">
                            <div>${questionData.front}</div>
                        </div>
                        <div class="flashcard-face flashcard-back">
                            <div>${questionData.back}</div>
                        </div>
                    </div>
                    <div class="flashcard-hint">
                        <i class="fas fa-hand-pointer"></i> Haz clic para voltear
                    </div>
                `;
                const flashcard = flashcardContainer.querySelector('.flashcard');
                flashcard.addEventListener('click', () => {
                    flashcard.classList.toggle('flipped');
                    if (this.state.selectedMode === 'examen' && !flashcard.dataset.answered) {
                        flashcard.dataset.answered = 'true';
                        setTimeout(() => this.showFlashcardComplete(), 500);
                    }
                });
                this.container.appendChild(flashcardContainer);
                if (this.state.selectedMode === 'estudio' || this.state.selectedMode === 'practica') {
                    document.getElementById('next-btn').classList.remove('hidden');
                }
            }
            showFlashcardComplete() {
                const feedbackContainer = document.getElementById('feedback-container');
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="feedback-header">
                        <i class="fas fa-check-circle" style="color: var(--success-color); font-size: 1.5rem;"></i>
                        <strong>¡Práctica completada!</strong>
                    </div>
                    <div>Las flashcards son herramientas de práctica. Sigue estudiando para dominar el concepto.</div>
                `;
                document.getElementById('next-btn').classList.remove('hidden');
            }
            renderAssociation(questionData) {
                const container = document.createElement('div');
                container.className = 'association-container';
                const leftColumn = document.createElement('div');
                leftColumn.className = 'association-column';
                const rightColumn = document.createElement('div');
                rightColumn.className = 'association-column';
                const shuffledItems2 = [...questionData.items2].sort(() => Math.random() - 0.5);
                questionData.items1.forEach((item, index) => {
                    const leftItem = document.createElement('div');
                    leftItem.className = 'assoc-item';
                    leftItem.textContent = item;
                    leftItem.dataset.key = item;
                    leftItem.addEventListener('click', () => this.selectAssociationItem(leftItem, 'left'));
                    leftColumn.appendChild(leftItem);
                    const rightItem = document.createElement('div');
                    rightItem.className = 'assoc-item';
                    rightItem.textContent = shuffledItems2[index];
                    rightItem.dataset.key = shuffledItems2[index];
                    rightItem.addEventListener('click', () => this.selectAssociationItem(rightItem, 'right'));
                    rightColumn.appendChild(rightItem);
                });
                container.appendChild(leftColumn);
                container.appendChild(rightColumn);
                this.container.appendChild(container);
                this.associationState = {
                    leftSelected: null,
                    rightSelected: null,
                    pairs: {},
                    questionData: questionData
                };
            }
            selectAssociationItem(item, side) {
                document.querySelectorAll(`.association-column .assoc-item.selected[data-side="${side}"]`).forEach(el => {
                    el.classList.remove('selected');
                    el.removeAttribute('data-side');
                });
                item.classList.add('selected');
                item.dataset.side = side;
                if (side === 'left') {
                    this.associationState.leftSelected = item;
                } else {
                    this.associationState.rightSelected = item;
                }
                if (this.associationState.leftSelected && this.associationState.rightSelected) {
                    this.checkAssociation();
                }
            }
            checkAssociation() {
                const leftKey = this.associationState.leftSelected.dataset.key;
                const rightKey = this.associationState.rightSelected.dataset.key;
                const correctAnswer = this.associationState.questionData.answer[leftKey];
                if (rightKey === correctAnswer) {
                    this.associationState.leftSelected.classList.add('correct');
                    this.associationState.rightSelected.classList.add('correct');
                    this.associationState.pairs[leftKey] = rightKey;
                    if (Object.keys(this.associationState.pairs).length === this.associationState.questionData.items1.length) {
                        this.handleAnswer(null, true, this.associationState.questionData);
                    }
                } else {
                    this.associationState.leftSelected.style.animation = 'wrongShake 0.4s ease';
                    this.associationState.rightSelected.style.animation = 'wrongShake 0.4s ease';
                    setTimeout(() => {
                        this.associationState.leftSelected.classList.remove('selected');
                        this.associationState.rightSelected.classList.remove('selected');
                        this.associationState.leftSelected.style.animation = '';
                        this.associationState.rightSelected.style.animation = '';
                    }, 400);
                }
                this.associationState.leftSelected = null;
                this.associationState.rightSelected = null;
            }
            handleAnswer(button, answer, questionData) {
                const isCorrect = answer === questionData.answer || answer === true;
                const shouldScore = questionData.type !== 'flashcard';
                if (questionData.type === 'multiple-choice' || questionData.type === 'fill-in-the-blank') {
                    this.disableAllOptions();
                    if (isCorrect) {
                        button.classList.add('correct');
                        if (shouldScore) {
                            this.state.score++;
                            this.state.streak++;
                        }
                    } else {
                        button.classList.add('wrong');
                        if (shouldScore) {
                            this.state.streak = 0;
                            this.state.wrongAnswers.push({
                                question: questionData.question,
                                userAnswer: answer,
                                correctAnswer: questionData.answer,
                                explanation: questionData.explanation,
                                source: questionData.source
                            });
                        }
                        document.querySelectorAll('.answer-btn').forEach(btn => {
                            if (btn.textContent === questionData.answer) {
                                btn.classList.add('correct');
                            }
                        });
                    }
                } else if (questionData.type === 'association') {
                    if (isCorrect && shouldScore) {
                        this.state.score++;
                        this.state.streak++;
                    }
                }
                if (shouldScore) {
                    this.state.totalAnswered++;
                    this.state.maxStreak = Math.max(this.state.maxStreak, this.state.streak);
                }
                if (this.state.selectedMode === 'estudio') {
                    this.showFeedback(isCorrect, questionData, shouldScore);
                } else {
                    setTimeout(() => this.goToNextQuestion(), shouldScore ? 2000 : 1500);
                }
            }
            disableAllOptions() {
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.disabled = true;
                });
            }
            showFeedback(isCorrect, questionData, shouldScore) {
                const feedbackContainer = document.getElementById('feedback-container');
                feedbackContainer.classList.remove('hidden');
                const icon = isCorrect ? '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>' : '<i class="fas fa-times-circle" style="color: var(--danger-color);"></i>';
                const scoreText = shouldScore ? (isCorrect ? '¡Correcto!' : 'Incorrecto') : '¡Práctica completada!';
                feedbackContainer.innerHTML = `
                    <div class="feedback-header">
                        ${icon}
                        <strong>${scoreText}</strong>
                    </div>
                    <div>${questionData.explanation}</div>
                    ${questionData.source ? `<div class="source">Fuente: ${questionData.source}</div>` : ''}
                `;
                document.getElementById('next-btn').classList.remove('hidden');
            }
            goToNextQuestion() {
                this.state.currentQuestionIndex++;
                if (this.state.currentQuestionIndex < this.state.currentQuestions.length) {
                    this.updateProgress();
                    this.render(this.state.currentQuestions[this.state.currentQuestionIndex]);
                } else {
                    this.state.showResults();
                }
            }
            updateProgress() {
                const progress = (this.state.currentQuestionIndex / this.state.currentQuestions.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').innerHTML = `
                    <i class="fas fa-list-ol"></i>
                    Pregunta ${this.state.currentQuestionIndex + 1} / ${this.state.currentQuestions.length}
                `;
            }
        }

        // ---------- CONTROLADOR PRINCIPAL ----------
        class QuizController {
            constructor() {
                this.state = new QuizState();
                this.renderer = new QuestionRenderer(document.getElementById('question-container'), this.state);
                this.state.showResults = this.showResults.bind(this);
                this.init();
            }
            init() {
                this.bindEvents();
                this.loadTheme();
                this.registerSW();
            }
            bindEvents() {
                // Modo selector
                document.querySelectorAll('.mode-selector button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.mode-selector button').forEach(b => {
                            b.classList.remove('selected');
                            b.setAttribute('aria-pressed', 'false');
                        });
                        e.currentTarget.classList.add('selected');
                        e.currentTarget.setAttribute('aria-pressed', 'true');
                        this.state.selectedMode = e.currentTarget.dataset.mode;
                    });
                });
                // Start button
                document.getElementById('start-btn').addEventListener('click', () => this.startQuiz());
                // Restart button
                document.getElementById('restart-btn').addEventListener('click', () => this.reset());
                // Next button
                document.getElementById('next-btn').addEventListener('click', () => this.renderer.goToNextQuestion());
                // Review errors
                document.getElementById('review-errors-btn').addEventListener('click', () => this.showReviewModal());
                // Modal close
                document.querySelector('.close-modal').addEventListener('click', () => {
                    document.getElementById('review-modal').classList.add('hidden');
                });
                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                // Download PDF
                document.getElementById('download-pdf-btn').addEventListener('click', () => this.downloadPDF());
                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.getElementById('review-modal').classList.add('hidden');
                    }
                });
            }
            loadTheme() {
                const saved = localStorage.getItem('theme') || 'dark';
                document.documentElement.setAttribute('data-theme', saved);
                this.updateThemeIcon(saved);
            }
            toggleTheme() {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                this.updateThemeIcon(next);
            }
            updateThemeIcon(theme) {
                const icon = document.querySelector('#theme-toggle i');
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            registerSW() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(() => {});
                }
            }
            startQuiz() {
                const theme = document.getElementById('theme-selector').value;
                let questions = theme === 'random' ? Object.values(quizData).flat() : [...quizData[theme]];
                questions = this.shuffleArray(questions);
                if (this.state.selectedMode !== 'practica') {
                    questions = questions.slice(0, 6);
                }
                this.state.currentQuestions = questions;
                this.state.currentQuestionIndex = 0;
                this.state.score = 0;
                this.state.streak = 0;
                this.state.maxStreak = 0;
                this.state.wrongAnswers = [];
                this.state.totalAnswered = 0;
                this.state.startTime = Date.now();
                this.showScreen('quiz-screen');
                this.renderer.render(questions[0]);
                this.startTimerIfNeeded();
            }
            showScreen(screenId) {
                document.querySelectorAll('#start-screen, #quiz-screen, #results-screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }
            startTimerIfNeeded() {
                if (this.state.selectedMode === 'examen') {
                    let timeLeft = 45;
                    const timerEl = document.getElementById('timer');
                    const timerContainer = document.getElementById('timer-container');
                    timerContainer.style.display = 'flex';
                    this.state.timerInterval = setInterval(() => {
                        timerEl.textContent = timeLeft;
                        timeLeft--;
                        if (timeLeft < 0) {
                            clearInterval(this.state.timerInterval);
                            this.handleTimeOut();
                        }
                    }, 1000);
                } else {
                    document.getElementById('timer-container').style.display = 'none';
                }
            }
            handleTimeOut() {
                const currentQuestion = this.state.currentQuestions[this.state.currentQuestionIndex];
                if (currentQuestion.type !== 'flashcard') {
                    this.state.wrongAnswers.push({
                        question: currentQuestion.question || currentQuestion.front,
                        userAnswer: 'Tiempo agotado',
                        correctAnswer: currentQuestion.answer || 'Ver respuesta',
                        explanation: currentQuestion.explanation,
                        source: currentQuestion.source
                    });
                }
                setTimeout(() => this.renderer.goToNextQuestion(), 1000);
            }
            showResults() {
                this.showScreen('results-screen');
                clearInterval(this.state.timerInterval);
                this.state.totalTime = Math.round((Date.now() - this.state.startTime) / 1000);
                const theme = document.getElementById('theme-selector').value;
                const accuracy = this.state.totalAnswered > 0 ? Math.round((this.state.score / this.state.totalAnswered) * 100) : 100;
                const isNewRecord = this.state.updateRecord(theme, this.state.score, this.state.totalAnswered, this.state.totalTime);
                document.getElementById('score-text').innerHTML = `<i class="fas fa-check-circle icon"></i> Tu puntaje: ${this.state.score} de ${this.state.totalAnswered}`;
                document.getElementById('accuracy-stat').textContent = `${accuracy}%`;
                document.getElementById('time-stat').textContent = this.formatTime(this.state.totalTime);
                document.getElementById('streak-stat').textContent = this.state.maxStreak;
                if (this.state.wrongAnswers.length > 0) {
                    this.showRecommendations();
                    document.getElementById('review-errors-btn').classList.remove('hidden');
                } else {
                    document.getElementById('recommendations').classList.add('hidden');
                    document.getElementById('review-errors-btn').classList.add('hidden');
                }
                if (isNewRecord) {
                    this.showNewRecordNotification();
                }
            }
            showRecommendations() {
                const recommendationsList = document.getElementById('recommendations-list');
                recommendationsList.innerHTML = '';
                const wrongTopics = [...new Set(this.state.wrongAnswers.map(a => a.source || 'General'))];
                wrongTopics.forEach(topic => {
                    const li = document.createElement('li');
                    li.innerHTML = `Sería buena idea repasar los conceptos del material: <span class="source">${topic}</span>`;
                    recommendationsList.appendChild(li);
                });
                document.getElementById('recommendations').classList.remove('hidden');
            }
            showReviewModal() {
                const reviewContent = document.getElementById('review-content');
                reviewContent.innerHTML = '';
                this.state.wrongAnswers.forEach((error, index) => {
                    const errorCard = document.createElement('div');
                    errorCard.className = 'error-card';
                    errorCard.innerHTML = `
                        <div class="error-question"><strong>Pregunta ${index + 1}:</strong> ${error.question}</div>
                        <div class="error-comparison">
                            <div class="user-answer"><strong>Tu respuesta:</strong><br>${error.userAnswer}</div>
                            <div class="correct-answer"><strong>Respuesta correcta:</strong><br>${error.correctAnswer}</div>
                        </div>
                        <div class="error-explanation"><strong>Explicación:</strong><br>${error.explanation}${error.source ? `<br><span class="source">Fuente: ${error.source}</span>` : ''}</div>
                    `;
                    reviewContent.appendChild(errorCard);
                });
                document.getElementById('review-modal').classList.remove('hidden');
            }
            showNewRecordNotification() {
                const notification = document.createElement('div');
                notification.className = 'new-record-notification';
                notification.innerHTML = `
                    <i class="fas fa-trophy" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
                    <div style="font-size: 2rem; margin-bottom: 10px;">¡Nuevo Récord!</div>
                    <div style="font-size: 1rem; opacity: 0.8;">¡Sigue así!</div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
            downloadPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const theme = document.getElementById('theme-selector').value;
                const accuracy = this.state.totalAnswered > 0 ? Math.round((this.state.score / this.state.totalAnswered) * 100) : 100;
                const date = new Date().toLocaleDateString('es-ES');
                
                // Título
                doc.setFontSize(20);
                doc.setTextColor(99, 102, 241);
                doc.text('Resultados - Psicometría Aplicada II', 20, 30);
                
                // Fecha
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Fecha: ${date}`, 20, 45);
                doc.text(`Tema: ${theme}`, 20, 55);
                
                // Resultados
                doc.text(`Puntaje: ${this.state.score} de ${this.state.totalAnswered}`, 20, 70);
                doc.text(`Precisión: ${accuracy}%`, 20, 80);
                doc.text(`Tiempo total: ${this.formatTime(this.state.totalTime)}`, 20, 90);
                doc.text(`Racha máxima: ${this.state.maxStreak}`, 20, 100);
                
                // Errores
                if (this.state.wrongAnswers.length > 0) {
                    doc.text(`Errores (${this.state.wrongAnswers.length}):`, 20, 120);
                    this.state.wrongAnswers.forEach((error, i) => {
                        const y = 130 + i * 40;
                        doc.setFontSize(10);
                        doc.text(`${i + 1}. ${error.question.substring(0, 80)}...`, 20, y);
                        doc.text(`Tu respuesta: ${error.userAnswer}`, 20, y + 6);
                        doc.text(`Correcta: ${error.correctAnswer}`, 20, y + 12);
                    });
                } else {
                    doc.text('¡No hubo errores! 🎉', 20, 120);
                }
                
                doc.save('resultados_psicometria.pdf');
            }
            reset() {
                this.showScreen('start-screen');
                this.loadRecords();
            }
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // ---------- INICIALIZAR ----------
        document.addEventListener('DOMContentLoaded', () => {
            new QuizController();
        });
    </script>
</body>
</html>
